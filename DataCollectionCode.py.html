<html>
<head>
<title>Project.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Project.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">asyncio</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">import </span><span class="s1">winsound</span>
<span class="s0">from </span><span class="s1">bleak </span><span class="s0">import </span><span class="s1">BleakClient</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">cluster </span><span class="s0">import </span><span class="s1">KMeans</span>
<span class="s0">import </span><span class="s1">csv</span>

<span class="s1">DEVICE_ADDRESS </span><span class="s2">= </span><span class="s3">&quot;1E:54:94:E5:F0:83&quot;</span>
<span class="s1">IMU_SERVICE_UUID </span><span class="s2">= </span><span class="s3">&quot;b8b4e50d-f686-4757-918a-fcd2292782de&quot;</span>
<span class="s1">SENSOR_CHAR_UUID </span><span class="s2">= </span><span class="s3">&quot;85212279-0d50-4ca0-9a7e-730bdebf8e74&quot;</span>

<span class="s1">forehand_count </span><span class="s2">= </span><span class="s4">0</span>
<span class="s1">backhand_count </span><span class="s2">= </span><span class="s4">0</span>
<span class="s1">overhead_count </span><span class="s2">= </span><span class="s4">0</span>
<span class="s1">shots </span><span class="s2">= </span><span class="s4">10</span>
<span class="s1">in_motion_window </span><span class="s2">= </span><span class="s0">False</span>
<span class="s1">motion_type </span><span class="s2">= </span><span class="s0">None</span>
<span class="s1">motion_interval_data </span><span class="s2">= {}</span>
<span class="s1">non_motion_interval_data </span><span class="s2">= {}</span>
<span class="s1">all_data </span><span class="s2">= []</span>


<span class="s0">def </span><span class="s1">calculate_features</span><span class="s2">(</span><span class="s1">sensor_data_list</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">sensor_data_list</span><span class="s2">:</span>
        <span class="s0">return None</span>

    <span class="s1">accel_x_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Accel_X'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">sensor_data_list</span><span class="s2">])</span>
    <span class="s1">accel_y_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Accel_Y'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">sensor_data_list</span><span class="s2">])</span>
    <span class="s1">accel_z_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Accel_Z'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">sensor_data_list</span><span class="s2">])</span>

    <span class="s1">gyro_x_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Gyro_X'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">sensor_data_list</span><span class="s2">])</span>
    <span class="s1">gyro_y_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Gyro_Y'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">sensor_data_list</span><span class="s2">])</span>
    <span class="s1">gyro_z_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Gyro_Z'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">sensor_data_list</span><span class="s2">])</span>

    <span class="s5"># Calculate differences between consecutive values</span>
    <span class="s1">accel_x_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">accel_x_values</span><span class="s2">)</span>
    <span class="s1">accel_y_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">accel_y_values</span><span class="s2">)</span>
    <span class="s1">accel_z_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">accel_z_values</span><span class="s2">)</span>
    <span class="s1">gyro_x_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">gyro_x_values</span><span class="s2">)</span>
    <span class="s1">gyro_y_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">gyro_y_values</span><span class="s2">)</span>
    <span class="s1">gyro_z_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">gyro_z_values</span><span class="s2">)</span>

    <span class="s5"># Calculate average of differences</span>
    <span class="s1">mean_accel_x_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">accel_x_diff</span><span class="s2">) </span><span class="s0">if </span><span class="s1">accel_x_diff</span><span class="s2">.</span><span class="s1">size </span><span class="s0">else </span><span class="s4">0</span>
    <span class="s1">mean_accel_y_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">accel_y_diff</span><span class="s2">) </span><span class="s0">if </span><span class="s1">accel_y_diff</span><span class="s2">.</span><span class="s1">size </span><span class="s0">else </span><span class="s4">0</span>
    <span class="s1">mean_accel_z_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">accel_z_diff</span><span class="s2">) </span><span class="s0">if </span><span class="s1">accel_z_diff</span><span class="s2">.</span><span class="s1">size </span><span class="s0">else </span><span class="s4">0</span>
    <span class="s1">mean_gyro_x_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">gyro_x_diff</span><span class="s2">) </span><span class="s0">if </span><span class="s1">gyro_x_diff</span><span class="s2">.</span><span class="s1">size </span><span class="s0">else </span><span class="s4">0</span>
    <span class="s1">mean_gyro_y_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">gyro_y_diff</span><span class="s2">) </span><span class="s0">if </span><span class="s1">gyro_y_diff</span><span class="s2">.</span><span class="s1">size </span><span class="s0">else </span><span class="s4">0</span>
    <span class="s1">mean_gyro_z_diff </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">gyro_z_diff</span><span class="s2">) </span><span class="s0">if </span><span class="s1">gyro_z_diff</span><span class="s2">.</span><span class="s1">size </span><span class="s0">else </span><span class="s4">0</span>

    <span class="s1">features </span><span class="s2">= {</span>
        <span class="s3">'Mean_Accel_X'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">accel_x_values</span><span class="s2">),</span>
        <span class="s3">'Mean_Accel_Y'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">accel_y_values</span><span class="s2">),</span>
        <span class="s3">'Mean_Accel_Z'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">accel_z_values</span><span class="s2">),</span>

        <span class="s3">'Max_Accel_X'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">accel_x_values</span><span class="s2">),</span>
        <span class="s3">'Max_Accel_Y'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">accel_y_values</span><span class="s2">),</span>
        <span class="s3">'Max_Accel_Z'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">accel_z_values</span><span class="s2">),</span>

        <span class="s3">'Min_Accel_X'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">accel_x_values</span><span class="s2">),</span>
        <span class="s3">'Min_Accel_Y'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">accel_y_values</span><span class="s2">),</span>
        <span class="s3">'Min_Accel_Z'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">accel_z_values</span><span class="s2">),</span>

        <span class="s3">'Mean_Gyro_X'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">gyro_x_values</span><span class="s2">),</span>
        <span class="s3">'Mean_Gyro_Y'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">gyro_y_values</span><span class="s2">),</span>
        <span class="s3">'Mean_Gyro_Z'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">gyro_z_values</span><span class="s2">),</span>

        <span class="s3">'Max_Gyro_X'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">gyro_x_values</span><span class="s2">),</span>
        <span class="s3">'Max_Gyro_Y'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">gyro_y_values</span><span class="s2">),</span>
        <span class="s3">'Max_Gyro_Z'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">gyro_z_values</span><span class="s2">),</span>

        <span class="s3">'Min_Gyro_X'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">gyro_x_values</span><span class="s2">),</span>
        <span class="s3">'Min_Gyro_Y'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">gyro_y_values</span><span class="s2">),</span>
        <span class="s3">'Min_Gyro_Z'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">min</span><span class="s2">(</span><span class="s1">gyro_z_values</span><span class="s2">),</span>

        <span class="s3">'Mean_Accel_X_Diff'</span><span class="s2">: </span><span class="s1">mean_accel_x_diff</span><span class="s2">,</span>
        <span class="s3">'Mean_Accel_Y_Diff'</span><span class="s2">: </span><span class="s1">mean_accel_y_diff</span><span class="s2">,</span>
        <span class="s3">'Mean_Accel_Z_Diff'</span><span class="s2">: </span><span class="s1">mean_accel_z_diff</span><span class="s2">,</span>

        <span class="s3">'Mean_Gyro_X_Diff'</span><span class="s2">: </span><span class="s1">mean_gyro_x_diff</span><span class="s2">,</span>
        <span class="s3">'Mean_Gyro_Y_Diff'</span><span class="s2">: </span><span class="s1">mean_gyro_y_diff</span><span class="s2">,</span>
        <span class="s3">'Mean_Gyro_Z_Diff'</span><span class="s2">: </span><span class="s1">mean_gyro_z_diff</span>
    <span class="s2">}</span>
    <span class="s1">new_centroid </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Accel_X'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Accel_Y'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Accel_Z'</span><span class="s2">],</span>
                             <span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Gyro_X'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Gyro_Y'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Gyro_Z'</span><span class="s2">],</span>
                             <span class="s1">features</span><span class="s2">[</span><span class="s3">'Max_Accel_X'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Max_Accel_Y'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Max_Accel_Z'</span><span class="s2">],</span>
                             <span class="s1">features</span><span class="s2">[</span><span class="s3">'Max_Gyro_X'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Max_Gyro_Y'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Max_Gyro_Z'</span><span class="s2">],</span>
                             <span class="s1">features</span><span class="s2">[</span><span class="s3">'Min_Accel_X'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Min_Accel_Y'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Min_Accel_Z'</span><span class="s2">],</span>
                             <span class="s1">features</span><span class="s2">[</span><span class="s3">'Min_Gyro_X'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Min_Gyro_Y'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Min_Gyro_Z'</span><span class="s2">],</span>
                             <span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Accel_X_Diff'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Accel_Y_Diff'</span><span class="s2">],</span>
                             <span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Accel_Z_Diff'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Gyro_X_Diff'</span><span class="s2">],</span>
                             <span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Gyro_Y_Diff'</span><span class="s2">], </span><span class="s1">features</span><span class="s2">[</span><span class="s3">'Mean_Gyro_Z_Diff'</span><span class="s2">]])</span>
    <span class="s1">centroid </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">new_centroid</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">features</span><span class="s2">[</span><span class="s3">'Centroid'</span><span class="s2">] = </span><span class="s1">centroid</span>

    <span class="s0">return </span><span class="s1">features</span>


<span class="s0">async def </span><span class="s1">main</span><span class="s2">():</span>
    <span class="s0">global </span><span class="s1">forehand_count</span><span class="s2">, </span><span class="s1">backhand_count</span><span class="s2">, </span><span class="s1">overhead_count</span><span class="s2">, </span><span class="s1">in_motion_window</span><span class="s2">, </span><span class="s1">motion_type</span><span class="s2">, </span><span class="s1">motion_interval_data</span><span class="s2">, </span><span class="s1">all_data</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">async with </span><span class="s1">BleakClient</span><span class="s2">(</span><span class="s1">DEVICE_ADDRESS</span><span class="s2">) </span><span class="s0">as </span><span class="s1">client</span><span class="s2">:</span>
            <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;Connected: </span><span class="s0">{</span><span class="s1">client</span><span class="s2">.</span><span class="s1">is_connected</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

            <span class="s0">await </span><span class="s1">client</span><span class="s2">.</span><span class="s1">start_notify</span><span class="s2">(</span><span class="s1">SENSOR_CHAR_UUID</span><span class="s2">, </span><span class="s1">on_sensor_data_changed</span><span class="s2">)</span>

            <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">gather</span><span class="s2">(</span><span class="s1">motion_indicator</span><span class="s2">(), </span><span class="s1">listen_for_sensor_data</span><span class="s2">(</span><span class="s1">client</span><span class="s2">))</span>

    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;An error occurred: </span><span class="s0">{</span><span class="s1">e</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">forehand_count </span><span class="s2">&gt;= </span><span class="s1">shots </span><span class="s0">and </span><span class="s1">backhand_count </span><span class="s2">&gt;= </span><span class="s1">shots </span><span class="s0">and </span><span class="s1">overhead_count </span><span class="s2">&gt;= </span><span class="s1">shots</span><span class="s2">:</span>
        <span class="s1">cluster_final_data</span><span class="s2">(</span><span class="s1">all_data</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">on_sensor_data_changed</span><span class="s2">(</span><span class="s1">sender</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
    <span class="s0">global </span><span class="s1">in_motion_window</span><span class="s2">, </span><span class="s1">motion_type</span><span class="s2">, </span><span class="s1">motion_interval_data</span><span class="s2">, </span><span class="s1">all_data</span><span class="s2">, </span><span class="s1">non_motion_interval_data</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">accel_x</span><span class="s2">, </span><span class="s1">accel_y</span><span class="s2">, </span><span class="s1">accel_z</span><span class="s2">, </span><span class="s1">gyro_x</span><span class="s2">, </span><span class="s1">gyro_y</span><span class="s2">, </span><span class="s1">gyro_z </span><span class="s2">= </span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">'ffffff'</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">sensor_data </span><span class="s2">= {</span>
            <span class="s3">'Accel_X'</span><span class="s2">: </span><span class="s1">accel_x</span><span class="s2">,</span>
            <span class="s3">'Accel_Y'</span><span class="s2">: </span><span class="s1">accel_y</span><span class="s2">,</span>
            <span class="s3">'Accel_Z'</span><span class="s2">: </span><span class="s1">accel_z</span><span class="s2">,</span>
            <span class="s3">'Gyro_X'</span><span class="s2">: </span><span class="s1">gyro_x</span><span class="s2">,</span>
            <span class="s3">'Gyro_Y'</span><span class="s2">: </span><span class="s1">gyro_y</span><span class="s2">,</span>
            <span class="s3">'Gyro_Z'</span><span class="s2">: </span><span class="s1">gyro_z</span>
        <span class="s2">}</span>

        <span class="s0">if </span><span class="s1">in_motion_window</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">motion_type </span><span class="s0">not in </span><span class="s1">motion_interval_data</span><span class="s2">:</span>
                <span class="s1">motion_interval_data</span><span class="s2">[</span><span class="s1">motion_type</span><span class="s2">] = []</span>
            <span class="s1">motion_interval_data</span><span class="s2">[</span><span class="s1">motion_type</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sensor_data</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s3">'non_motion' </span><span class="s0">not in </span><span class="s1">non_motion_interval_data</span><span class="s2">:</span>
                <span class="s1">non_motion_interval_data</span><span class="s2">[</span><span class="s3">'non_motion'</span><span class="s2">] = []</span>
            <span class="s1">non_motion_interval_data</span><span class="s2">[</span><span class="s3">'non_motion'</span><span class="s2">].</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sensor_data</span><span class="s2">)</span>

    <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s3">f&quot;Error processing sensor data: </span><span class="s0">{</span><span class="s1">e</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">in_motion_window </span><span class="s0">and </span><span class="s1">motion_interval_data</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">motion</span><span class="s2">, </span><span class="s1">data_list </span><span class="s0">in </span><span class="s1">motion_interval_data</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">features </span><span class="s2">= </span><span class="s1">calculate_features</span><span class="s2">(</span><span class="s1">data_list</span><span class="s2">)</span>
            <span class="s1">features</span><span class="s2">[</span><span class="s3">'Motion'</span><span class="s2">] = </span><span class="s1">motion</span>
            <span class="s1">all_data</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">features</span><span class="s2">)</span>
        <span class="s1">motion_interval_data </span><span class="s2">= {}</span>

    <span class="s0">if </span><span class="s1">in_motion_window </span><span class="s0">and </span><span class="s1">non_motion_interval_data</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">motion</span><span class="s2">, </span><span class="s1">data_list </span><span class="s0">in </span><span class="s1">non_motion_interval_data</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">features </span><span class="s2">= </span><span class="s1">calculate_features</span><span class="s2">(</span><span class="s1">data_list</span><span class="s2">)</span>
            <span class="s1">features</span><span class="s2">[</span><span class="s3">'Motion'</span><span class="s2">] = </span><span class="s1">motion</span>
            <span class="s1">all_data</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">features</span><span class="s2">)</span>
        <span class="s1">non_motion_interval_data </span><span class="s2">= {}</span>


<span class="s0">async def </span><span class="s1">motion_indicator</span><span class="s2">():</span>
    <span class="s0">global </span><span class="s1">in_motion_window</span><span class="s2">, </span><span class="s1">forehand_count</span><span class="s2">, </span><span class="s1">backhand_count</span><span class="s2">, </span><span class="s1">overhead_count</span><span class="s2">, </span><span class="s1">motion_type</span>

    <span class="s0">while </span><span class="s1">forehand_count </span><span class="s2">&lt; </span><span class="s1">shots </span><span class="s0">or </span><span class="s1">backhand_count </span><span class="s2">&lt; </span><span class="s1">shots </span><span class="s0">or </span><span class="s1">overhead_count </span><span class="s2">&lt; </span><span class="s1">shots</span><span class="s2">:</span>
        <span class="s1">winsound</span><span class="s2">.</span><span class="s1">Beep</span><span class="s2">(</span><span class="s4">2500</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">in_motion_window </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">winsound</span><span class="s2">.</span><span class="s1">Beep</span><span class="s2">(</span><span class="s4">1000</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)  </span><span class="s5"># forehand beep</span>
        <span class="s1">motion_type </span><span class="s2">= </span><span class="s3">&quot;forehand&quot;</span>
        <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">in_motion_window </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">forehand_count </span><span class="s2">+= </span><span class="s4">1</span>

        <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">in_motion_window </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">winsound</span><span class="s2">.</span><span class="s1">Beep</span><span class="s2">(</span><span class="s4">1500</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)  </span><span class="s5"># backhand beep</span>
        <span class="s1">motion_type </span><span class="s2">= </span><span class="s3">&quot;backhand&quot;</span>
        <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">in_motion_window </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">backhand_count </span><span class="s2">+= </span><span class="s4">1</span>

        <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">in_motion_window </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s1">winsound</span><span class="s2">.</span><span class="s1">Beep</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)  </span><span class="s5"># overhead beep</span>
        <span class="s1">motion_type </span><span class="s2">= </span><span class="s3">&quot;smash&quot;</span>
        <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">in_motion_window </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">overhead_count </span><span class="s2">+= </span><span class="s4">1</span>


<span class="s0">async def </span><span class="s1">listen_for_sensor_data</span><span class="s2">(</span><span class="s1">client</span><span class="s2">):</span>
    <span class="s0">global </span><span class="s1">forehand_count</span><span class="s2">, </span><span class="s1">backhand_count</span><span class="s2">, </span><span class="s1">overhead_count</span>

    <span class="s0">while </span><span class="s1">client</span><span class="s2">.</span><span class="s1">is_connected </span><span class="s0">and </span><span class="s2">(</span><span class="s1">forehand_count </span><span class="s2">&lt; </span><span class="s1">shots </span><span class="s0">or </span><span class="s1">backhand_count </span><span class="s2">&lt; </span><span class="s1">shots </span><span class="s0">or </span><span class="s1">overhead_count </span><span class="s2">&lt; </span><span class="s1">shots</span><span class="s2">):</span>
        <span class="s0">await </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">sleep</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Done&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">cluster_final_data</span><span class="s2">(</span><span class="s1">data</span><span class="s2">):</span>
    <span class="s1">motion_types </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Motion'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">mean_accel_x </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Accel_X'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">mean_accel_y </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Accel_Y'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">mean_accel_z </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Accel_Z'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">mean_gyro_x </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Gyro_X'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">mean_gyro_y </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Gyro_Y'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">mean_gyro_z </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Gyro_Z'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">max_accel_x </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Max_Accel_X'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">max_accel_y </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Max_Accel_Y'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">max_accel_z </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Max_Accel_Z'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">max_gyro_x </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Max_Gyro_X'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">max_gyro_y </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Max_Gyro_Y'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">max_gyro_z </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Max_Gyro_Z'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">min_accel_x </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Min_Accel_X'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">min_accel_y </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Min_Accel_Y'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">min_accel_z </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Min_Accel_Z'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">min_gyro_x </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Min_Gyro_X'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">min_gyro_y </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Min_Gyro_Y'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">min_gyro_z </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Min_Gyro_Z'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">mean_accel_x_diff </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Accel_X_Diff'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">mean_accel_y_diff </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Accel_Y_Diff'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">mean_accel_z_diff </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Accel_Z_Diff'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">mean_gyro_x_diff </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Gyro_X_Diff'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">mean_gyro_y_diff </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Gyro_Y_Diff'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>
    <span class="s1">mean_gyro_z_diff </span><span class="s2">= [</span><span class="s1">item</span><span class="s2">[</span><span class="s3">'Mean_Gyro_Z_Diff'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">data</span><span class="s2">]</span>

    <span class="s1">feature_matrix </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">((</span>
        <span class="s1">mean_accel_x</span><span class="s2">, </span><span class="s1">mean_accel_y</span><span class="s2">, </span><span class="s1">mean_accel_z</span><span class="s2">,</span>
        <span class="s1">mean_gyro_x</span><span class="s2">, </span><span class="s1">mean_gyro_y</span><span class="s2">, </span><span class="s1">mean_gyro_z</span><span class="s2">,</span>
        <span class="s1">max_accel_x</span><span class="s2">, </span><span class="s1">max_accel_y</span><span class="s2">, </span><span class="s1">max_accel_z</span><span class="s2">,</span>
        <span class="s1">max_gyro_x</span><span class="s2">, </span><span class="s1">max_gyro_y</span><span class="s2">, </span><span class="s1">max_gyro_z</span><span class="s2">,</span>
        <span class="s1">min_accel_x</span><span class="s2">, </span><span class="s1">min_accel_y</span><span class="s2">, </span><span class="s1">min_accel_z</span><span class="s2">,</span>
        <span class="s1">min_gyro_x</span><span class="s2">, </span><span class="s1">min_gyro_y</span><span class="s2">, </span><span class="s1">min_gyro_z</span><span class="s2">,</span>
        <span class="s1">mean_accel_x_diff</span><span class="s2">, </span><span class="s1">mean_accel_y_diff</span><span class="s2">, </span><span class="s1">mean_accel_z_diff</span><span class="s2">,</span>
        <span class="s1">mean_gyro_x_diff</span><span class="s2">, </span><span class="s1">mean_gyro_y_diff</span><span class="s2">, </span><span class="s1">mean_gyro_z_diff</span>
    <span class="s2">))</span>

    <span class="s1">kmeans </span><span class="s2">= </span><span class="s1">KMeans</span><span class="s2">(</span><span class="s1">n_clusters</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">kmeans</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">feature_matrix</span><span class="s2">)</span>
    <span class="s1">cluster_labels </span><span class="s2">= </span><span class="s1">kmeans</span><span class="s2">.</span><span class="s1">labels_</span>
    <span class="s1">centroids </span><span class="s2">= </span><span class="s1">kmeans</span><span class="s2">.</span><span class="s1">cluster_centers_</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s3">&quot;Cluster Labels:&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span><span class="s1">cluster_labels</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s3">'DataSet.csv'</span><span class="s2">, </span><span class="s3">'w'</span><span class="s2">, </span><span class="s1">newline</span><span class="s2">=</span><span class="s3">''</span><span class="s2">) </span><span class="s0">as </span><span class="s1">csvfile</span><span class="s2">:</span>
        <span class="s1">csvwriter </span><span class="s2">= </span><span class="s1">csv</span><span class="s2">.</span><span class="s1">writer</span><span class="s2">(</span><span class="s1">csvfile</span><span class="s2">)</span>
        <span class="s1">csvwriter</span><span class="s2">.</span><span class="s1">writerow</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s3">'Motion'</span><span class="s2">, </span><span class="s3">'Centroid'</span><span class="s2">, </span><span class="s3">'Label'</span><span class="s2">, </span><span class="s3">'Mean_Ax'</span><span class="s2">, </span><span class="s3">'Mean_Ay'</span><span class="s2">, </span><span class="s3">'Mean_Az'</span><span class="s2">,</span>
             <span class="s3">'Mean_Gx'</span><span class="s2">, </span><span class="s3">'Mean_Gy'</span><span class="s2">, </span><span class="s3">'Mean_Gz'</span><span class="s2">, </span><span class="s3">'Max_Ax'</span><span class="s2">, </span><span class="s3">'Max_Ay'</span><span class="s2">, </span><span class="s3">'Max_Az'</span><span class="s2">, </span><span class="s3">'Max_Gx'</span><span class="s2">, </span><span class="s3">'Max_Gy'</span><span class="s2">, </span><span class="s3">'Max_Gz'</span><span class="s2">,</span>
             <span class="s3">'Min_Ax'</span><span class="s2">, </span><span class="s3">'Min_Ay'</span><span class="s2">, </span><span class="s3">'Min_Az'</span><span class="s2">, </span><span class="s3">'Min_Gx'</span><span class="s2">, </span><span class="s3">'Min_Gy'</span><span class="s2">, </span><span class="s3">'Min_Gz'</span><span class="s2">,</span>
             <span class="s3">'Mean_Diff_Ax'</span><span class="s2">, </span><span class="s3">'Mean_Diff_Ay'</span><span class="s2">, </span><span class="s3">'Mean_Diff_Az'</span><span class="s2">,</span>
             <span class="s3">'Mean_Diff_Gx'</span><span class="s2">, </span><span class="s3">'Mean_Diff_Gy'</span><span class="s2">, </span><span class="s3">'Mean_Diff_Gz'</span><span class="s2">])</span>

        <span class="s1">csvwriter</span><span class="s2">.</span><span class="s1">writerows</span><span class="s2">([(</span><span class="s1">motion</span><span class="s2">, </span><span class="s1">centroids</span><span class="s2">[</span><span class="s1">label</span><span class="s2">], </span><span class="s1">label</span><span class="s2">, </span><span class="s1">mean_accel_x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">mean_accel_y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">mean_accel_z</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
                              <span class="s1">mean_gyro_x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">mean_gyro_y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">mean_gyro_z</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
                              <span class="s1">max_accel_x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">max_accel_y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">max_accel_z</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
                              <span class="s1">max_gyro_x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">max_gyro_y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">max_gyro_z</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
                              <span class="s1">min_accel_x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">min_accel_y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">min_accel_z</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
                              <span class="s1">min_gyro_x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">min_gyro_y</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">min_gyro_z</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
                              <span class="s1">mean_accel_x_diff</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">mean_accel_y_diff</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">mean_accel_z_diff</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
                              <span class="s1">mean_gyro_x_diff</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">mean_gyro_y_diff</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">mean_gyro_z_diff</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
                             <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">motion</span><span class="s2">, </span><span class="s1">label</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">motion_types</span><span class="s2">, </span><span class="s1">cluster_labels</span><span class="s2">))])</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">&quot;__main__&quot;</span><span class="s2">:</span>
    <span class="s1">asyncio</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">main</span><span class="s2">())</span>
</pre>
</body>
</html>